---
title: ğŸ™‹â€â™‚ï¸ Redis åº•å±‚å®ç°
sidebar_position: 2
---

----

## Redis æ˜¯å¦‚ä½•å®ç°å­—ç¬¦ä¸²çš„ï¼Ÿ

SDSï¼ˆSimple Dynamic Stringï¼‰ç®€å•åŠ¨æ€å­—ç¬¦ä¸²æ˜¯ Redis åº•å±‚å®ç°çš„ä¸€ç§å¯ä¿®æ”¹å­—ç¬¦ä¸²ã€‚ç±»ä¼¼äº Java ä¸­çš„ `ArrayList`ï¼Œå®ƒé‡‡ç”¨é¢„åˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ã€‚SDS æ¯” C è¯­è¨€çš„å­—ç¬¦ä¸²å¤šäº†ä¸€ä¸ª `SDSHDR` è¡¨å¤´ï¼Œé‡Œé¢å­˜æ”¾ `free`ï¼ˆç©ºé—²é•¿åº¦ï¼‰ã€`len`ï¼ˆå·²ä½¿ç”¨é•¿åº¦ï¼‰ã€`buf`ï¼ˆçœŸæ­£ä¿å­˜çš„é‚£ä¸ªå­—ç¬¦ä¸²ï¼‰ã€‚æºç ä¸­æä¾›çš„ `sds` ç±»å‹å®é™…ä¸Šæ˜¯ `char *` çš„åˆ«åï¼Œå®ƒçœŸæ­£æŒ‡å‘çš„æ˜¯ buf æ•°ç»„ã€‚

ä¼˜ç‚¹ï¼š

- è·å–å­—ç¬¦ä¸²é•¿åº¦æ›´å¿«ï¼šC è¯­è¨€è·å–å­—ç¬¦ä¸²é•¿åº¦éœ€è¦éå†æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(N)$ï¼ŒSDS çš„è¡¨å¤´ `len` æˆå‘˜å­˜æ”¾äº†å½“å‰å·²ä½¿ç”¨é•¿åº¦ï¼Œè·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦ä¸º $O(1)$
- æœç»ç¼“å†²åŒºæº¢å‡ºï¼šC è¯­è¨€å­—ç¬¦ä¸²æœ¬èº«ä¸è®°å½•è‡ªèº«é•¿åº¦å’Œç©ºé—²ç©ºé—´ï¼Œå®¹æ˜“é€ æˆç¼“å†²åŒºæº¢å‡ºï¼ŒSDS è¡¨å¤´çš„ `free` æˆå‘˜å­˜æ”¾äº†ç©ºé—²ç©ºé—´ï¼Œæ‹¼æ¥å­—ç¬¦ä¸²å‰ä¼šå…ˆé€šè¿‡ `free` å­—æ®µæ£€æµ‹å‰©ä½™ç©ºé—´æ˜¯å¦èƒ½æ»¡è¶³ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿå°±ä¼šæ‰©å®¹
- å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°ï¼šC è¯­è¨€å¯¹å­—ç¬¦ä¸²è¿›è¡Œå¢é•¿æˆ–ç¼©çŸ­æ“ä½œï¼Œéƒ½éœ€è¦é‡æ–°åˆ†é…å†…å­˜ï¼ŒSDS ä½¿ç”¨äº†ç©ºé—´é¢„åˆ†é…å’Œæƒ°æ€§ç©ºé—´é‡Šæ”¾ç­–ç•¥ï¼Œå‡å°‘äº†å†…å­˜åˆ†é…æ¬¡æ•°
- äºŒè¿›åˆ¶å®‰å…¨ï¼šC è¯­è¨€å­—ç¬¦ä¸²é‡ `\0` åˆ™æ­¢ï¼Œä¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œæˆªæ–­ï¼Œè€Œ SDS åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“å°¾çš„ä¾æ®æ˜¯å¤´ä¿¡æ¯ä¸­çš„ `len` å±æ€§ï¼Œå³ä½¿ SDS ä¸­é—´ä¿å­˜äº† `\0` ä¹Ÿä¸å½±å“

## SDS çš„æ‰©å®¹æœºåˆ¶ï¼Ÿ

SDS æºç æä¾›äº† `sdsMakeRoomFor()` å‡½æ•°æ¥è¿›è¡Œæ‰©å®¹ï¼Œå®ƒçš„å‚æ•°æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ª `sds` ç±»å‹çš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸€ä¸ªæ•°å­— `addlen`ã€‚å…·ä½“çš„æµç¨‹å¦‚ä¸‹ï¼š

![sdsæ‰©å®¹æµç¨‹å›¾.jpg](https://i.loli.net/2021/07/31/zYeV1apdblOAScB.png)

## Redis çš„å­—å…¸æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

C è¯­è¨€æ²¡æœ‰æä¾›å­—å…¸ï¼ŒRedis æä¾›äº†ä¸€ç§å®ç°ã€‚`Hash` ç±»å‹çš„åº•å±‚å®ç°æ˜¯å­—å…¸ã€‚å®ƒæ ¹æ®é”®å€¼å¯¹ä¸­çš„é”®è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œç„¶åæ ¹æ®ç´¢å¼•å€¼ï¼Œå°†åŒ…å«é”®å€¼å¯¹çš„å“ˆå¸ŒèŠ‚ç‚¹æ”¾åˆ°å“ˆå¸Œæ•°ç»„çš„æŒ‡å®šç´¢å¼•ä¸Šã€‚

### è§£å†³å“ˆå¸Œå†²çª

Redis é‡‡ç”¨é“¾åœ°å€æ³•è§£å†³é”®å†²çªï¼Œæ¯ä¸ªå“ˆå¸ŒèŠ‚ç‚¹æœ‰ä¸€ä¸ª `next` æŒ‡é’ˆï¼Œå¤šä¸ªå“ˆå¸ŒèŠ‚ç‚¹é€šè¿‡ `next` æŒ‡é’ˆæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæœ€æ–°çš„èŠ‚ç‚¹æ€»æ˜¯æ·»åŠ åˆ°è¡¨å¤´ã€‚

### rehash

å­—å…¸ä¸­ä¿å­˜ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼š`ht[0]` å’Œ `ht[1]`ï¼Œ`ht[1]` åªåœ¨ `rehash` æ—¶ä½¿ç”¨ã€‚Redis å¯¹å­—å…¸çš„å“ˆå¸Œè¡¨æ‰§è¡Œ `rehash` çš„æ­¥éª¤å¦‚ä¸‹ï¼š

- ä¸º `ht[1]` å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´ï¼Œ`ht[1]` çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº `ht[0].used * 2` çš„ $2^n$
- å°†ä¿å­˜åœ¨ `ht[0]` ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ `rehash` åˆ° `ht[1]` ä¸Šé¢
- å½“ `ht[0]` åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿ç§»åˆ° `ht[1]` ä¹‹åï¼Œé‡Šæ”¾ `ht[0]`ï¼Œå°† `ht[1]` è®¾ç½®ä¸º `ht[0]`ï¼Œå¹¶ä¸º `ht[1]` æ–°åˆ›å»ºä¸€ä¸ªç©ºç™½å“ˆå¸Œè¡¨ï¼Œä¸ºä¸‹ä¸€æ¬¡ `rehash` åšå‡†å¤‡

:::info æ¸è¿›å¼ rehash
`rehash` åŠ¨ä½œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼çš„å®Œæˆçš„ã€‚å¦‚æœæœåŠ¡å™¨ä¸­åŒ…å«å¾ˆå¤šé”®å€¼å¯¹ï¼Œè¦ä¸€æ¬¡æ€§çš„å°†è¿™äº›é”®å€¼å¯¹å…¨éƒ¨ `rehash` åˆ° `ht[1]` çš„è¯ï¼Œåºå¤§çš„è®¡ç®—é‡å¯èƒ½å¯¼è‡´æœåŠ¡å™¨åœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢æœåŠ¡ã€‚
:::

## Redis çš„è·³è·ƒè¡¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

è·³è·ƒè¡¨æ˜¯æœ‰åºé›†åˆï¼ˆ`zset`ï¼‰çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œå®ƒæ˜¯åŸºäºå¤šæŒ‡é’ˆæœ‰åºé“¾è¡¨å®ç°çš„ï¼Œå¯ä»¥çœ‹æˆå¤šä¸ªæœ‰åºé“¾è¡¨ã€‚

![è·³è·ƒè¡¨.png](https://i.loli.net/2021/07/31/sWy4M7OYBSGvm8h.png)

åœ¨æŸ¥æ‰¾æ—¶ï¼Œä»ä¸Šå±‚æŒ‡é’ˆå¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å¯¹åº”çš„åŒºé—´ä¹‹åå†åˆ°ä¸‹ä¸€å±‚å»æŸ¥æ‰¾ã€‚ä¸‹å›¾æ¼”ç¤ºäº†æŸ¥æ‰¾ 22 çš„è¿‡ç¨‹ï¼š

![è·³è·ƒè¡¨æŸ¥æ‰¾.png](https://i.loli.net/2021/07/31/L3tyY2nzQTOZx6e.png)

ä¸çº¢é»‘æ ‘ç­‰å¹³è¡¡æ ‘ç›¸æ¯”ï¼Œè·³è·ƒè¡¨å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- æ’å…¥é€Ÿåº¦éå¸¸å¿«é€Ÿï¼Œå› ä¸ºä¸éœ€è¦è¿›è¡Œæ—‹è½¬ç­‰æ“ä½œæ¥ç»´æŠ¤å¹³è¡¡æ€§
- æ›´å®¹æ˜“å®ç°
- æ”¯æŒæ— é”æ“ä½œ

:::info ziplist å’Œ skiplist
é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ `zset` ä¸­é›†åˆçš„å…ƒç´ ä¸ªæ•°å°‘äº 128 ä¸ªï¼ˆå¯¹åº”é…ç½®é¡¹ `zset-max-ziplist-value`ï¼‰å¹¶ä¸” `zadd` æ“ä½œçš„ `member` çš„é•¿åº¦å°äº 64 å­—èŠ‚ï¼ˆå¯¹åº”é…ç½®é¡¹ `zset-max-ziplist-entries`ï¼‰ï¼ŒRedis ä¼šä½¿ç”¨ `ziplist` æ¥å­˜å‚¨å…ƒç´ ï¼Œå¦åˆ™ä½¿ç”¨ `skiplist` æ¥å­˜å‚¨å…ƒç´ ã€‚

ä¿®æ”¹ `zset-max-ziplist-value` ä¸º 3ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œæŸ¥çœ‹ Redis æ‰€ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼š

```text
127.0.0.1:6379> zadd myset 10 "A"
(integer) 1
127.0.0.1:6379> object encoding myset
"ziplist"

// æ­¤å¤„çœç•¥æ’å…¥æ•°æ® BB å’Œ CCC çš„è¿‡ç¨‹ï¼Œå®ƒä»¬çš„ç»“æœä¹Ÿæ˜¯ ziplist

127.0.0.1:6379> zadd myset 10 "DDDD"
127.0.0.1:6379> object encoding myset
"skiplist"
```
:::

## ä»‹ç»ä¸€ä¸‹ Redis çš„çº¿ç¨‹æ¨¡å‹ï¼Ÿ

![Redisçº¿ç¨‹æ¨¡å‹.png](https://i.loli.net/2021/07/31/PK4j3RF1mJsIqbe.png)
